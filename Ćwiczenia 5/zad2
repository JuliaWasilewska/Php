<?php
session_start();
include('functions.php');

// Odczytanie zawartości pliku CSV z produktami
$products = readCsvFile('products.csv');

// Dodanie produktu do koszyka po kliknięciu w przycisk "do koszyka"
if (isset($_POST['product_id'])) {
    $product_id = $_POST['product_id'];
    $product = $products[$product_id];
    addToCart($product_id, $product['name'], $product['price'], 1);
}

// Usunięcie produktu z koszyka po kliknięciu w przycisk "usuń"
if (isset($_GET['action']) && $_GET['action'] == 'remove' && isset($_GET['product_id'])) {
    $product_id = $_GET['product_id'];
    removeFromCart($product_id);
}

// Wyczyszczenie koszyka po kliknięciu w przycisk "wyczyść koszyk"
if (isset($_POST['clear_cart'])) {
    clearCart();
}

// Wyświetlenie zawartości koszyka
$cart = getCart();
?>

<h1>Sklep</h1>

<h2>Produkty</h2>
<ul>
    <?php foreach ($products as $id => $product): ?>
        <li>
            <?php echo $product['name'] ?> (<?php echo $product['price'] ?> zł)
            <form method="post">
                <input type="hidden" name="product_id" value="<?php echo $id ?>">
                <input type="submit" value="do koszyka">
            </form>
        </li>
    <?php endforeach; ?>
</ul>

<h2>Koszyk</h2>
<?php if (empty($cart)): ?>
    <p>Koszyk jest pusty</p>
<?php else: ?>
    <table>
        <tr>
            <th>Nazwa</th>
            <th>Cena</th>
            <th>Ilość</th>
            <th>Suma</th>
            <th>Akcja</th>
        </tr>
        <?php foreach ($cart as $id => $item): ?>
            <tr>
                <td><?php echo $item['name'] ?></td>
                <td><?php echo $item['price'] ?> zł</td>
                <td>
                    <form method="post">
                        <input type="hidden" name="product_id" value="<?php echo $id ?>">
                        <input type="number" name="quantity" value="<?php echo $item['quantity'] ?>" min="1" step="1">
                        <input type="submit" value="zmień">
                    </form>
                </td>
                <td><?php echo $item['price'] * $item['quantity'] ?> zł</td>
                <td>
                    <a href="?action=remove&product_id=<?php echo $id ?>">usuń</a>
                </td>
            </tr>
        <?php endforeach; ?>
        <tr>
            <td colspan="3">Suma:</td>
            <td><?php echo getCartTotal() ?> zł</td>
            <td>
                <form method="post">
                    <input type="submit" name="clear_cart" value="wyczyść koszyk">
                </form>
            </td>
        </tr>
    </table>
<?php
